<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible Paragraph Sermon</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
      transition:border-color .15s, transform .04s;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    button:active{ transform:translateY(1px) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }
    .ptoolbar .spacer { flex: 1 1 auto; }
    
    /* ì„±ê²½ë³¸ë¬¸ ì„œì‹ ë²„íŠ¼ ì˜ì—­ */
    .pcontent-format-toolbar {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-left: 8px;
    }
    .pcontent-format-toolbar .fmt-btn {
      padding: 4px 8px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .pcontent-format-toolbar .fmt-btn:hover {
      background: color-mix(in hsl, var(--panel) 85%, white 15%);
      border-color: var(--accent);
    }
    .pcontent-format-toolbar .fmt-color-palette {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-left: 4px;
    }
    .pcontent-format-toolbar .fmt-color-btn {
      cursor: pointer;
      border: 1px solid #2a3040;
      border-radius: 4px;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .pcontent-format-toolbar .fmt-color-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 0 8px rgba(110, 168, 254, 0.4);
    }

    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent); position:relative }
    .pline.reading::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--accent); border-radius:4px 0 0 4px; animation:pulse 1.5s ease-in-out infinite }
    @keyframes pulse{ 0%, 100%{ opacity:1 } 50%{ opacity:0.6 } }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:8px }
    .item{ border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }

    .context-editor {
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-size: 1.05rem;
      line-height: 1.85;
      letter-spacing: 0.02em;
      word-break: keep-all;
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    .context-editor input[type="text"]{
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-weight: 600;
      font-size: 1.12rem;
      letter-spacing: 0.01em;
    }
    .context-editor .rte{
      min-height:360px;resize:vertical;padding:14px;background:#161922;border:1px solid #2a3040;border-radius:10px;line-height:1.85;letter-spacing:.015em;caret-color:var(--accent);outline:none
    }
    .context-editor em,.context-editor strong,.context-editor b{
      color:#ffd66e;font-weight:600;font-style:normal
    }
    .context-editor blockquote{
      margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);
      color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px
    }
    .context-editor ::selection{background:rgba(110,168,254,.25)}
    @media (max-width:640px){.context-editor{font-size:1rem}}
    @media (prefers-color-scheme:light){
      .context-editor{color:#1b2533;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.08)}
      .context-editor blockquote{color:#445066;background:#f7f9fc}
    }

    #sermonEditor.context-editor .rte{
      line-height: 1.55 !important;
      letter-spacing: 0.01em !important;
    }
    #sermonEditor.context-editor .rte p{ margin: 6px 0; }
    #sermonEditor.context-editor .rte .verse-line{ line-height: 1.5; }
    #sermonEditor.context-editor .rte .verse-line sup{ margin-right:4px; }
    #sermonEditor.context-editor .rte br{ line-height: 1.0; }

    #sermonEditor{
      display:flex; flex-direction:column;
      height: calc(94vh - 56px); min-height: calc(94vh - 56px); max-height: calc(94vh - 56px);
      overflow: hidden;
    }
    #sermonEditor .rte {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding-top: var(--editor-pad-top, 0px);
      margin-top: 0 !important;
      scroll-padding-top: var(--editor-pad-top, 0px);
    }

    #rteToolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    .inserted-verse { font-style: italic; color: #ff8080; }
    .verse-header { margin-bottom:2px; }
    .verse-line { font-style: italic; color:#ff8080; }

    .link-box{ display:flex; align-items:center; gap:6px; min-width:260px; flex:1 1 320px; }
    .link-box input{
      flex:1 1 auto; min-width:200px;
      background:#161922;color:#e6e8ef;border:1px solid #2a3040;border-radius:8px;padding:6px 8px
    }
    .link-box a{
      text-decoration:underline; color:#9fd0ff; word-break:break-all;
      max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    /* í”Œë¡œíŒ… ì„œì‹íˆ´ë°” */
    #wbp-plbar{
      position: fixed; left:0; top:0;
      transform: translate(-50%, calc(-100% - 10px));
      background:#0f1320; border:1px solid var(--border);
      border-radius:10px; padding:6px;
      display:flex; gap:6px; align-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35); z-index:9999;
    }
    #wbp-plbar[hidden]{ display:none; }
    #wbp-plbar .divider{ width:1px; height:20px; background:var(--border); }
    #wbp-plbar button{
      border:1px solid var(--border); background:#1f2533; color:#e6e8ef;
      padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    #wbp-plbar button:hover{ background:#273046; }
    #wbp-plbar select{ background:#1f2533; color:#e6e8ef; border:1px solid var(--border); border-radius:6px; padding:4px 6px }

    /* ë‚´ìš© ì±„ì›Œì§„ ë²„íŠ¼(filled) ì‹œê° ê°•ì¡° + í•­ëª©ë³„ ìƒ‰ */
    .ptoolbar button.filled { color:#fff; border-width:1px; box-shadow:0 0 6px rgba(0,0,0,0.25) }
    .ptoolbar .btnSummary.filled    { background:#6a5acd; border-color:#7b68ee; }
    .ptoolbar .btnUnitCtx.filled    { background:#9370db; border-color:#b48cf0; }
    .ptoolbar .btnWholeCtx.filled   { background:#4682b4; border-color:#5ca5e5; }
    .ptoolbar .btnCommentary.filled { background:#3cb371; border-color:#58d68d; }
    .ptoolbar .sermBtn.filled       { background:#ff8c00; border-color:#ffa94d; }
    .ptoolbar button.filled::after{
      content:"â—"; font-size:10px; margin-left:6px; opacity:.85; color:rgba(255,255,255,.9);
    }

    /* í¸ì§‘ ëª¨ë“œ í‘œì‹œ(ì„ íƒ) */
    details.para .pcontent[contenteditable="true"]{
      outline: 1px dashed #3b4b7a; outline-offset: 2px;
    }

    /* ===== Unit Chips (ptitle ì˜† íë¦¿í•œ ë²„íŠ¼) ===== */
    .unit-chips { display:inline-flex; gap:6px; margin-left:8px; vertical-align:middle; }
    .unit-chip {
      font: 600 11px/1.8 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      padding: 0 8px;
      border-radius: 999px;
      border: 1px solid var(--border, #252a36);
      background: color-mix(in srgb, var(--bg, #0f1115) 92%, #ffffff 8%);
      color: color-mix(in srgb, var(--text, #e6e8ef) 28%, var(--bg, #0f1115) 72%);
      opacity: .72;
      transition: opacity .15s ease, color .15s ease, border-color .15s ease, background .15s ease;
      cursor: pointer;
    }
    .unit-chip:hover {
      opacity: 1;
      color: var(--text, #e6e8ef);
      border-color: color-mix(in srgb, var(--border, #252a36) 60%, var(--text, #e6e8ef) 40%);
      background: color-mix(in srgb, var(--bg, #0f1115) 85%, #ffffff 15%);
    }
    .unit-chip:active { transform: translateY(1px); }

    /* ===== Unit Editor (ì˜¤ë¥¸ìª½ í•˜ë‹¨ íŒì—…) ===== */
    .unit-editor {
      position: fixed; right: 16px; bottom: 16px;
      width: min(520px, 92vw); height: 60vh;
      background: var(--panel, #161922);
      border: 1px solid var(--border, #252a36);
      border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display: none; flex-direction: column; z-index: 100000;
    }
    .unit-editor header {
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px; border-bottom:1px solid var(--border, #252a36);
    }
    .unit-editor header .ue-title {
      font-weight:700; color: var(--text, #e6e8ef); font-size: 13px;
    }
    .unit-editor .ue-actions { display:flex; gap:8px; }
    .unit-editor .ue-actions button {
      font-size:12px; padding:6px 10px; border-radius:8px; border:1px solid var(--border, #252a36);
      background: color-mix(in srgb, var(--panel, #161922) 90%, #ffffff 10%);
      color: var(--text, #e6e8ef); cursor:pointer;
    }
    .unit-editor .ue-actions button:hover { background: color-mix(in srgb, var(--panel, #161922) 80%, #ffffff 20%); }
    .unit-editor textarea {
      width: 100%; height: 100%; flex:1; resize:none; outline:none; border:0; padding:12px;
      background: transparent; color: var(--text, #e6e8ef); font: 13px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans KR", monospace;
    }

    /* ===== Unit Chips: ê°€ì‹œì„± ë³´ì¥(ì„ì‹œ ê°•ì œ) ===== */
    .unit-chips { display:inline-flex !important; gap:6px; margin-left:8px; vertical-align:middle; opacity:1 !important; }
    .unit-chip  { color: var(--text, #e6e8ef) !important; border-color: var(--border, #252a36) !important; }
    summary { position: relative; } /* summary ë‚´ ì¸ë¼ì¸ ë°°ì¹˜ ì•ˆì •í™” */

    /* ===== [GLOBAL BOOK CHIPS] í—¤ë” ì˜¤ë¥¸ìª½ ì¹©ìŠ¤ ===== */
    #globalBookChips{
      display:inline-flex;
      gap:6px;
      margin-left:8px;
      opacity:.85;
      align-items:center;
    }
    #globalBookChips .book-chip{
      font:600 11px/1.9 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      padding:0 10px;
      border-radius:999px;
      cursor:pointer;
      border:1px solid var(--border,#252a36);
      background: color-mix(in srgb, var(--bg,#0f1115) 92%, #fff 8%);
      color: color-mix(in srgb, var(--text,#e6e8ef) 28%, var(--bg,#0f1115) 72%);
      transition: background .15s ease, color .15s ease, border-color .15s ease, opacity .15s ease;
    }
    #globalBookChips .book-chip:hover{
      opacity:1;
      color:var(--text,#e6e8ef);
      border-color: color-mix(in srgb, var(--border,#252a36) 60%, var(--text,#e6e8ef) 40%);
      background: color-mix(in srgb, var(--bg,#0f1115) 85%, #fff 15%);
    }

    /* ===== [BOOK-HEAD CHIPS] ì±… 1ì¥ ì²« ë‹¨ë½ 'ì„¤êµ' ì˜¤ë¥¸ìª½ ì¹©ìŠ¤ ===== */
.bookhead-chips{
  display:inline-flex;
  gap:6px;
  margin-left:8px;
  vertical-align:middle;
}
.bookhead-chips .bookhead-chip{
  font:600 11px/1.9 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  padding:0 10px;
  border-radius:999px;
  cursor:pointer;
  border:1px solid var(--border,#252a36);
  background: color-mix(in srgb, var(--bg,#0f1115) 92%, #fff 8%);
  color: color-mix(in srgb, var(--text,#e6e8ef) 28%, var(--bg,#0f1115) 72%);
  transition: background .15s ease, color .15s ease, border-color .15s ease, opacity .15s ease;
}
.bookhead-chips .bookhead-chip:hover{
  opacity:1;
  color:var(--text,#e6e8ef);
  border-color: color-mix(in srgb, var(--border,#252a36) 60%, var(--text,#e6e8ef) 40%);
  background: color-mix(in srgb, var(--bg,#0f1115) 85%, #fff 15%);
}

/* ===== book head chips (ì„¤êµ ì˜¤ë¥¸ìª½) ===== */
.ptoolbar .bookhead-chips{
  display:inline-flex;
  gap:6px;
  margin-left:8px;
  opacity:.9;
}
.ptoolbar .bookhead-chips .book-chip{
  font: inherit;
  padding: 4px 8px;
  border: 1px solid var(--border,#252a36);
  background: var(--panel,#161922);
  color: var(--text,#e6e8ef);
  border-radius: 8px;
  cursor: pointer;
}
.ptoolbar .bookhead-chips .book-chip:hover{
  filter: brightness(1.08);
}

/* === ë²„íŠ¼ ê¸€ì í¬ê¸° í†µì¼ (ë‚´ìš©íë¦„ ë²„íŠ¼ ê¸°ì¤€) === */
.ptoolbar button,
.ptoolbar .book-chip,
.ptoolbar .bookhead-chips button,
.ptoolbar .chip {
  font-size: 0.9rem !important;
  line-height: 1.2 !important;
}

/* ===== book head chips (ì„¤êµ ì˜¤ë¥¸ìª½) ===== */
.ptoolbar .bookhead-chips{
  display:inline-flex;
  gap:6px;
  margin-left:8px;
  opacity:.9;
}
.ptoolbar .bookhead-chips .book-chip{
  font: inherit;
  padding: 4px 8px;
  border: 1px solid var(--border,#252a36);
  background: var(--panel,#161922);
  color: var(--text,#e6e8ef);
  border-radius: 8px;
  cursor: pointer;
}
.ptoolbar .bookhead-chips .book-chip:hover{
  filter: brightness(1.08);
}

.bookunit-wrap{
  margin-left: 8px;
  display: inline-flex;
  gap: 4px;
  opacity: 0.8;
}

.bookunit-wrap:hover{
  opacity: 1;
}

.bookunit-btn{
  font-size: 0.9rem;            /* ë‚´ìš©íë¦„ ë²„íŠ¼ í¬ê¸°ì™€ ë¹„ìŠ·í•˜ê²Œ */
  padding: 3px 8px;
  border-radius: 6px;
  border: 1px solid var(--border, #252a36);
  background: transparent;
  color: var(--muted, #9aa0ab);
  cursor: pointer;
}

.bookunit-btn:hover{
  background: var(--panel, #161922);
  color: var(--text, #e6e8ef);
}

  </style>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Web Bible Paragraph 3.5</h1>

    <div class="pill"><button id="btnSaveJSON">JSON ì €ì¥</button></div>

    <div class="pill">
      <button id="btnExportAll">ë‚´ìš©ë‚´ë³´ë‚´ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">ë‚´ìš©ê°€ì ¸ì˜¤ê¸°</button>
    </div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraphs.jsonì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong id="modalTitle">ë‹¨ë½ ì„±ê²½</strong>
        <span class="muted" id="modalRef">â€”</span>
        <div class="grow"></div>
        <button id="closeModal">ë‹«ê¸°</button>
      </div>

      <div class="list" id="sermonList"></div>

      <!-- ë‹¨ì¼ í¸ì§‘ê¸° -->
      <div class="editor context-editor" id="sermonEditor" style="display:none">
        <div id="rteToolbar" class="editor-bar">
          <button type="button" id="insertVerseBtn" title="í˜„ì¬ ë‹¨ë½ì˜ ì„±êµ¬ ì‚½ì…">ì„±êµ¬ì‚½ì…</button>
          <div class="grow"></div>
        </div>

        <input id="sermonTitle" type="text" placeholder="ì œëª©" style="display:none" />
        <div id="sermonMetaFields" style="display:none; padding: 12px; background: var(--panel, #161922); border-radius: 4px; margin-bottom: 12px;">
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 12px; color: var(--muted, #9aa0ab); margin-bottom: 4px;">ì´ˆì </label>
            <input id="sermonFocus" type="text" placeholder="ì„¤êµì˜ ì´ˆì ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border, #252a36); border-radius: 4px; font-size: 14px; background: var(--bg, #0f1115); color: var(--text, #e6e8ef);" />
          </div>
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 12px; color: var(--muted, #9aa0ab); margin-bottom: 4px;">í‚¤ì›Œë“œ</label>
            <input id="sermonKeywords" type="text" placeholder="í‚¤ì›Œë“œë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border, #252a36); border-radius: 4px; font-size: 14px; background: var(--bg, #0f1115); color: var(--text, #e6e8ef);" />
          </div>
          <div>
            <label style="display: block; font-size: 12px; color: var(--muted, #9aa0ab); margin-bottom: 4px;">ì ìš©ëŒ€ìƒ</label>
            <input id="sermonTarget" type="text" placeholder="ì ìš©ëŒ€ìƒì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border, #252a36); border-radius: 4px; font-size: 14px; background: var(--bg, #0f1115); color: var(--text, #e6e8ef);" />
          </div>
        </div>
        <div id="sermonBody" class="rte" contenteditable="true" spellcheck="false"></div>

        <div class="editor-bar">
          <div class="grow"></div>
          <button id="editorSpeak" class="primary">ë‚­ë…</button>
          <button id="saveSermon" class="primary">ì €ì¥</button>
        </div>
      </div>

      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border); display: flex; gap: 8px; justify-content: space-between; align-items: center;">
        <button id="saveSermonListBtn" class="primary">ì„¤êµëª©ë¡ì €ì¥</button>
        <button id="newSermonBtn" class="primary">ìƒˆ ì„¤êµëª©ë¡</button>
      </div
    </div>
  </div>

  <!-- í”Œë¡œíŒ… ì„œì‹íˆ´ë°”(ì ˆ ì„ íƒ ì‹œ í‘œì‹œ) -->
  <div id="wbp-plbar" hidden role="toolbar" aria-label="ì ˆ ì„œì‹">
    <button type="button" data-cmd="createLink" title="ë§í¬ (Ctrl+K)">ğŸ”—</button>
    <div class="divider"></div>
    <!-- ì—¬ê¸° ë’¤ì— 7ìƒ‰ íŒ”ë ˆíŠ¸ê°€ JSë¡œ ì£¼ì…ë©ë‹ˆë‹¤ -->
  </div>

  <!-- ì•± ë³¸ì²´ -->
  <script src="app.js" defer></script>

  <!-- v3.5 ì½”ì–´: 1) ì €ì¥ì†Œ -->
  <script>
  const WBP_FMT_KEY = 'wbps.versefmt.v2';
  const WBP_FMT = {
    map: {},
    load(){
      try { 
        if (typeof loadState === 'function') {
          this.map = loadState(WBP_FMT_KEY, {});
        } else {
          this.map = JSON.parse(localStorage.getItem(WBP_FMT_KEY) || '{}');
        }
      }
      catch { this.map = {}; }
    },
    save(){ 
      if (typeof saveState === 'function') {
        saveState(WBP_FMT_KEY, this.map);
      } else {
        localStorage.setItem(WBP_FMT_KEY, JSON.stringify(this.map));
      }
      // ì„œì‹ ì €ì¥ í›„ ë²„íŠ¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      if (typeof updateButtonColors === 'function') {
        setTimeout(updateButtonColors, 100);
      }
    },
    keyForLine(line){
      try{
        const para = line.closest('details.para'); if(!para) return null;
        const t = para.querySelector('summary .ptitle'); if(!t) return null;
        const book = t.dataset.book, ch = +t.dataset.ch, idx = +t.dataset.idx;
        const paraData = window.BIBLE?.books?.[book]?.[ch]?.paras?.[idx]; if(!paraData) return null;
        const v = line.dataset.verse || line.getAttribute('data-verse'); if(!v) return null;
        return `${book}|${ch}|${paraData.ref}|v${v}`;
      }catch{ return null; }
    },
    saveLine(line){
      const k = this.keyForLine(line); if(!k) return;
      this.map[k] = line.innerHTML;
      this.save();
    },
    restoreLine(line){
      const k = this.keyForLine(line); if(!k) return;
      const html = this.map[k];
      if (html) line.innerHTML = html;
    },
    restoreAll(root=document){
      root.querySelectorAll('.pline, .verse-line, p.verse').forEach(el=>this.restoreLine(el));
    }
  };
  WBP_FMT.load();
  </script>

  <!-- v3.5 ì½”ì–´: 2) ë Œë” ì™„ë£Œ ë³µì› + ë°±ì—… ì˜µì €ë²„ -->
  <script>
  // buildTree() ëì—ì„œ app.jsê°€ dispatch í•´ì•¼ í•¨:
  // document.dispatchEvent(new CustomEvent('wbp:treeBuilt'));
  document.addEventListener('wbp:treeBuilt', ()=>{
    const root = document.getElementById('tree') || document;
    WBP_FMT.restoreAll(root);

    // âœ… ê° ì±…ì˜ 1ì¥ ì²« ë‹¨ë½ 'ì„¤êµ' ì˜¤ë¥¸ìª½ì— ì¹©ìŠ¤ ë°°ì¹˜
    ensureBookHeadChips();
  });

  // êµ¬í˜•/ë°±ì—…: íŠ¸ë¦¬ ë‚´ë¶€ DOM ì¶”ê°€ ì‹œ ìƒˆ ì ˆ ìë™ ë³µì›
  (function(){
    const root = document.getElementById('tree');
    if(!root) return;
    // ì´ˆê¸° 1íšŒ ìŠ¤ìœ•
    WBP_FMT.restoreAll(root);
    let isRestoring = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
    const mo = new MutationObserver((muts)=>{
      if(isRestoring) return; // ì´ë¯¸ ë³µì› ì¤‘ì´ë©´ ë¬´ì‹œ
      for(const m of muts){
        m.addedNodes?.forEach?.(n=>{
          if(!(n instanceof HTMLElement)) return;
          // ë³µì› ëŒ€ìƒì¸ì§€ í™•ì¸
          const needsRestore = n.matches?.('.pline, .verse-line, p.verse') || 
                               n.querySelectorAll?.('.pline, .verse-line, p.verse')?.length > 0;
          if(needsRestore) {
            isRestoring = true;
            try {
              if(n.matches?.('.pline, .verse-line, p.verse')) WBP_FMT.restoreLine(n);
              n.querySelectorAll?.('.pline, .verse-line, p.verse')?.forEach?.(x=>WBP_FMT.restoreLine(x));
            } finally {
              // ë‹¤ìŒ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ í”Œë˜ê·¸ í•´ì œ
              setTimeout(() => { isRestoring = false; }, 0);
            }
          }
        });
      }
    });
    mo.observe(root, {subtree:true, childList:true});
  })();
  </script>

  <!-- v3.5 ì½”ì–´: 3) í”Œë¡œíŒ…íˆ´ë°” í‘œì‹œ/ì ìš© ì¦‰ì‹œ ì €ì¥ + 6ìƒ‰ íŒ”ë ˆíŠ¸ -->
  <script>
  (function enableFloatingToolbar(){
    const bar = document.getElementById('wbp-plbar');
    if(!bar) return;

    // 7ìƒ‰ íŒ”ë ˆíŠ¸ ì£¼ì… (í°ìƒ‰ í¬í•¨, ê¸°íƒ€ìƒ‰ ë“œë¡­ë‹¤ìš´ ì œê±°)
    (function injectPalette(){
      if(bar.querySelector('.wbp-colors')) return;
      const PALETTE = ['#ff4d4f','#faad14','#fadb14','#52c41a','#1677ff','#722ed1','#ffffff'];
      const wrap = document.createElement('div');
      wrap.className = 'wbp-colors';
      PALETTE.forEach(hex=>{
        const b = document.createElement('button');
        b.type='button'; 
        b.title=hex === '#ffffff' ? 'í°ìƒ‰' : hex; 
        b.style.cssText=`width:22px;height:22px;border-radius:5px;border:1px solid ${hex === '#ffffff' ? '#666' : '#2a3040'};background:${hex};`;
        b.addEventListener('click', ()=>{
          document.execCommand?.('foreColor', false, hex);
          saveCurrentLine();
        });
        wrap.appendChild(b);
      });
      bar.appendChild(wrap);
    })();

    // ì„ íƒ ë¼ì¸ íƒìƒ‰
    function currentLineFromSelection(){
      const sel = window.getSelection?.();
      if(!sel || !sel.rangeCount) return null;
      const n = sel.getRangeAt(0).commonAncestorContainer;
      const el = (n.nodeType===1 ? n : n.parentElement);
      // ëª¨ë“  í¸ì§‘ê¸°ì˜ #sermonBody ì¸ì‹
      // - ì±… ë‹¨ìœ„: book-basic, book-struct, book-summary
      // - ë‹¨ë½ ë‹¨ìœ„: summary, unit, whole, commentary
      const sermonBody = el?.closest?.('#sermonBody');
      if (sermonBody) {
        const sermonEditor = sermonBody.closest('#sermonEditor');
        if (sermonEditor && sermonEditor.dataset.ctxType) {
          const ctxType = sermonEditor.dataset.ctxType;
          const allowedTypes = ['summary', 'unit', 'whole', 'commentary'];
          if (ctxType.startsWith('book-') || allowedTypes.includes(ctxType)) {
            return sermonBody; // í¸ì§‘ê¸°ì—ì„œëŠ” sermonBody ë°˜í™˜
          }
        }
      }
      return el?.closest?.('.pline, .verse-line, p.verse') || null;
    }
    function hasRealSelection(){
      const sel = window.getSelection?.();
      return !!(sel && sel.rangeCount && !sel.getRangeAt(0).collapsed);
    }
    function selRect(){
      const sel = window.getSelection();
      if(!sel || sel.rangeCount===0) return null;
      const r = sel.getRangeAt(0).cloneRange();
      let rect = r.getBoundingClientRect();
      if(!rect || (rect.width===0 && rect.height===0)){
        const span = document.createElement('span');
        span.appendChild(document.createTextNode('\u200b'));
        r.insertNode(span);
        rect = span.getBoundingClientRect();
        span.remove();
      }
      return rect;
    }
    let savedRange=null;
    function saveSel(){ const s=window.getSelection(); if(s&&s.rangeCount>0) savedRange=s.getRangeAt(0).cloneRange(); }
    function restoreSel(){ if(!savedRange) return false; const s=window.getSelection(); s.removeAllRanges(); s.addRange(savedRange); return true; }

    function showBarMaybe(){
      if(!hasRealSelection()){ hide(); return; }
      const line = currentLineFromSelection();
      if(!line){ hide(); return; }
      // contenteditable ë³´ì¥(í•„ìš” ì‹œ)
      (line.closest('.pcontent, .editor, main, body')||line).setAttribute('contenteditable','true');
      const rect = selRect(); if(!rect){ hide(); return; }
      bar.style.left = (rect.left + rect.width/2) + 'px';
      bar.style.top  = rect.top + 'px';
      bar.hidden = false;
      saveSel();
    }
    function hide(){ bar.hidden = true; }

    // íˆ´ë°” ê¸°ë³¸ ë²„íŠ¼(B/I/U/ë§í¬) â†’ ì ìš© í›„ ì €ì¥
    bar.addEventListener('mousedown', e=> e.preventDefault());
    bar.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const cmd = btn.dataset.cmd;
      if(cmd){
        if(!restoreSel()) return;
        if (cmd === 'createLink') {
          const sel = window.getSelection();
          if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
            const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:', 'https://');
            if (url) {
              document.execCommand('createLink', false, url);
            }
          }
        } else {
          document.execCommand(cmd, false, null);
        }
        setTimeout(saveCurrentLine, 0);
        setTimeout(showBarMaybe, 0);
      }
    });

    // ë‹¨ì¶•í‚¤ (ë…¸ì…˜ ìŠ¤íƒ€ì¼: Ctrl+B/I/U/K, Ctrl+Shift+H: ê¸€ììƒ‰) í›„ ì €ì¥
    document.addEventListener('keydown', (e)=>{
      const line = currentLineFromSelection();
      if (!line) return;
      
      // Ctrl+Shift+H: ê¸€ììƒ‰ ì„ íƒ
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key?.toLowerCase() === 'h') {
        e.preventDefault();
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
          // HTML5 color input ì‚¬ìš©
          const colorInput = document.createElement('input');
          colorInput.type = 'color';
          colorInput.value = '#000000';
          colorInput.style.position = 'fixed';
          colorInput.style.opacity = '0';
          colorInput.style.pointerEvents = 'none';
          document.body.appendChild(colorInput);
          
          colorInput.addEventListener('change', () => {
            document.execCommand('foreColor', false, colorInput.value);
            document.body.removeChild(colorInput);
            setTimeout(saveCurrentLine, 0);
            setTimeout(showBarMaybe, 0);
          });
          
          colorInput.addEventListener('blur', () => {
            if (document.body.contains(colorInput)) {
              document.body.removeChild(colorInput);
            }
          });
          
          colorInput.click();
        }
        return;
      }
      
      // Ctrl+B/I/U/K
      if(!(e.ctrlKey||e.metaKey) || e.shiftKey) return;
      const k = e.key?.toLowerCase();
      if(!['b','i','u','k'].includes(k)) return;
      e.preventDefault();
      if (k === 'k') {
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
          const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:', 'https://');
          if (url) {
            document.execCommand('createLink', false, url);
            setTimeout(saveCurrentLine, 0);
          }
        }
      } else {
        document.execCommand(k === 'b' ? 'bold' : k === 'i' ? 'italic' : 'underline', false, null);
        setTimeout(saveCurrentLine, 0);
      }
      setTimeout(showBarMaybe, 0);
    });
    // ì…ë ¥/ë§ˆìš°ìŠ¤ì—…ì—ë„ ì €ì¥ (ë¬´í•œ ë£¨í”„ ë°©ì§€: ë””ë°”ìš´ì‹± ê°•í™”)
    let inputTimeout = null;
    let isSaving = false;
    document.addEventListener('input', ()=> {
      if (isSaving) return; // ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (inputTimeout) clearTimeout(inputTimeout);
      inputTimeout = setTimeout(() => {
        isSaving = true;
        try {
          saveCurrentLine();
        } finally {
          setTimeout(() => { isSaving = false; }, 50);
        }
        inputTimeout = null;
      }, 200); // 120msì—ì„œ 200msë¡œ ì¦ê°€í•˜ì—¬ ë¬´í•œ ë£¨í”„ ë°©ì§€
    });
    // mouseupê³¼ selectionchange ì´ë²¤íŠ¸ëŠ” app.jsì˜ createFloatingToolbarì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì¤‘ë³µ ì œê±°
    // document.addEventListener('mouseup', ()=> setTimeout(showBarMaybe, 0));
    // document.addEventListener('selectionchange', ()=> setTimeout(showBarMaybe, 0));
    window.addEventListener('scroll', hide, {passive:true});
    window.addEventListener('resize', hide);

    let isSavingLine = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
    function saveCurrentLine(){
      if (isSavingLine) return; // ì´ë¯¸ ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
      const line = currentLineFromSelection(); if(!line) return;
      // #sermonBodyì˜ ê²½ìš° WBP_FMT ì €ì¥ì€ í•˜ì§€ ì•ŠìŒ (í¸ì§‘ê¸° ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥ë¨)
      if (line.id === 'sermonBody') {
        // ì„œì‹ì€ ì´ë¯¸ DOMì— ì ìš©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì €ì¥ ë¶ˆí•„ìš”
        return;
      }
      isSavingLine = true;
      try {
        WBP_FMT.saveLine(line);
      } finally {
        // ë‹¤ìŒ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ í”Œë˜ê·¸ í•´ì œ
        setTimeout(() => { isSavingLine = false; }, 0);
      }
    }
  })();
  </script>

  <!-- v3.5 ì½”ì–´: 4) ë‹¨ë½ ì„œì‹ ì´ˆê¸°í™” ë²„íŠ¼ + filled ìƒíƒœ í† ê¸€ -->
  <script>
  // ë²„íŠ¼ filled ìƒíƒœ ê°±ì‹ (ë‚´ìš©íë¦„/ë‹¨ìœ„/ì „ì²´/ì£¼ì„/ì„¤êµ)
  (function filledStatePatch(){
    function safe(fn, fb){ try{ return fn(); }catch{ return fb; } }
    function paraId(book, chap, idx){
      const para = safe(()=>BIBLE.books[book][chap].paras[idx], null);
      return para ? `${book}|${chap}|${para.ref}` : null;
    }
    function pickMeta(paraEl){
      const t = paraEl.querySelector('summary .ptitle'); if(!t) return null;
      return { book:t.dataset.book, chap:+t.dataset.ch, idx:+t.dataset.idx };
    }
    function hasDoc(map, pid){
      const d=(map||{})[pid]; if(!d) return false;
      const b=(d.body||'').replace(/\s+/g,''); const ti=(d.title||'').replace(/\s+/g,'');
      return !!(b||ti);
    }
    function hasSermon(sermonMap, pid){
      const arr=(sermonMap||{})[pid]||[]; if(!Array.isArray(arr)||arr.length===0) return false;
      return arr.some(it=> (it.body||'').replace(/\s+/g,'') || (it.title||'').replace(/\s+/g,''));
    }
    function applyFilled(paraEl){
      const m = pickMeta(paraEl); if(!m) return;
      const pid = paraId(m.book, m.chap, m.idx); if(!pid) return;

      const sermonMap = safe(()=>{
        if (typeof loadState === 'function') return loadState(STORAGE_SERMON, {});
        return JSON.parse(localStorage.getItem(STORAGE_SERMON)||'{}');
      },{});
      const unitMap   = safe(()=>{
        if (typeof loadState === 'function') return loadState(STORAGE_UNIT_CTX, {});
        return JSON.parse(localStorage.getItem(STORAGE_UNIT_CTX)||'{}');
      },{});
      const wholeMap  = safe(()=>{
        if (typeof loadState === 'function') return loadState(STORAGE_WHOLE_CTX, {});
        return JSON.parse(localStorage.getItem(STORAGE_WHOLE_CTX)||'{}');
      },{});
      const commMap   = safe(()=>{
        if (typeof loadState === 'function') return loadState(STORAGE_COMMENTARY, {});
        return JSON.parse(localStorage.getItem(STORAGE_COMMENTARY)||'{}');
      },{});
      const sumMap    = safe(()=>{
        if (typeof loadState === 'function') return loadState(STORAGE_SUMMARY, {});
        return JSON.parse(localStorage.getItem(STORAGE_SUMMARY)||'{}');
      },{});

      const tb = paraEl.querySelector('.ptoolbar'); if(!tb) return;
      const q = s=>tb.querySelector(s);

      q('.btnSummary')   ?.classList.toggle('filled', hasDoc(sumMap,  pid));
      q('.btnUnitCtx')   ?.classList.toggle('filled', hasDoc(unitMap, pid));
      q('.btnWholeCtx')  ?.classList.toggle('filled', hasDoc(wholeMap,pid));
      q('.btnCommentary')?.classList.toggle('filled', hasDoc(commMap, pid));
      q('.sermBtn')      ?.classList.toggle('filled', hasSermon(sermonMap, pid));
    }
    let isSweepingFilled = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
    function sweep(){ 
      if(isSweepingFilled) return; // ì´ë¯¸ ìŠ¤ìœ• ì¤‘ì´ë©´ ë¬´ì‹œ
      isSweepingFilled = true;
      try {
        document.querySelectorAll('#tree details.para').forEach(applyFilled);
      } finally {
        // ë‹¤ìŒ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ í”Œë˜ê·¸ í•´ì œ
        setTimeout(() => { isSweepingFilled = false; }, 0);
      }
    }

    // buildTree ì´í›„ ê°±ì‹ 
    document.addEventListener('wbp:treeBuilt', sweep);
    // êµ¬ì¡° ë³€ë™ ì‹œ ê°±ì‹ 
    (function(){
      const root=document.getElementById('tree'); if(!root) return;
      setTimeout(sweep, 200);
      new MutationObserver(()=>sweep()).observe(root, {subtree:true, childList:true});
    })();
  })();

  // ë‹¨ë½ ì„œì‹ì´ˆê¸°í™” ë²„íŠ¼ ì œê±°ë¨ (ì‚¬ìš©ì ìš”ì²­)
  </script>

    <script>
    // === Export handler dedupe guard ===
    (function ensureSingleExportHandler(){
      const btn = document.getElementById('btnExportAll');
      if(!btn) return;
    
      // ì´ë¯¸ ë°”ì¸ë”© í–ˆë‹¤ë©´ ì¬ë°”ì¸ë”© ê¸ˆì§€
      if (btn.dataset.boundExport === '1') return;
    
      // í˜¹ì‹œ ì¸ë¼ì¸ onclickì´ ìˆë‹¤ë©´ ì œê±°(í•œ ë²ˆì— ë)
      if (typeof btn.onclick === 'function') btn.onclick = null;
    
      // ê¸°ì¡´ì— addEventListenerë¡œ ë¬¶ì¸ ê²Œ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ,
      // ë²„íŠ¼ì„ í´ë¡ â†’êµì²´í•˜ì—¬ ëª¨ë“  ì´ì „ ë¦¬ìŠ¤ë„ˆë¥¼ 'ì´ˆê¸°í™”'
      const clone = btn.cloneNode(true);
      clone.id = 'btnExportAll';              // id ìœ ì§€
      clone.dataset.boundExport = '1';        // ë°”ì¸ë”© ì™„ë£Œ ë§ˆí¬
      btn.replaceWith(clone);
    
      // ì´ì œë¶€í„°ëŠ” ìš°ë¦¬ ìª½ í•¸ë“¤ëŸ¬ë§Œ ì—°ê²°í•˜ë©´ ë‘ ë²ˆ ì‹¤í–‰ ì•ˆ ë¨
      window.__WBP_GET_EXPORT_BUTTON__ = () => document.getElementById('btnExportAll');
    })();
    </script>
  
    <!-- === WBP Export/Import (ì ˆë¬¸ì¥ ì„œì‹ í¬í•¨) === -->
    <script>
    window.addEventListener('DOMContentLoaded', function(){
      // ë‚´ë³´ë‚¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ í•„í„°: ìš°ë¦¬ ì•± ë„¤ì„ìŠ¤í˜ì´ìŠ¤ + ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•˜ëŠ” í‚¤
      const EXPORT_PREFIXES = ['wbps.', 'WBP.', 'wbp.'];   // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í”„ë¦¬í”½ìŠ¤
      const MUST_KEYS = [
        'wbps.versefmt.v1',            // âœ… ì ˆë¬¸ì¥ ì„œì‹ë§µ
        'STORAGE_SERMON',              // ì„¤êµ ëª©ë¡(í”„ë¡œì íŠ¸ë³„ ìƒì´í•  ìˆ˜ ìˆìŒ)
        'STORAGE_UNIT_CTX',            // ë‹¨ìœ„ì„±ê²½ì† ë§¥ë½
        'STORAGE_WHOLE_CTX',           // ì „ì²´ì„±ê²½ì† ë§¥ë½
        'STORAGE_COMMENTARY',          // ì£¼ì„
        'STORAGE_SUMMARY'              // ë‚´ìš©íë¦„ ìš”ì•½
      ];
    
      function isOurKey(k){
        return EXPORT_PREFIXES.some(p=> k.startsWith(p)) || MUST_KEYS.includes(k);
      }
    
      function collectAll(){
        const out = {};
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(!isOurKey(k)) continue;
          if (typeof loadState === 'function') {
            out[k] = loadState(k, null);
          } else {
            const raw = localStorage.getItem(k);
            try{ out[k] = JSON.parse(raw); } catch{ out[k] = raw; }
          }
        }
        return out;
      }
    
      function downloadJSON(obj, name){
        const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        const t = new Date();
        const fname = name || `wbp-export-${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}-${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}${String(t.getSeconds()).padStart(2,'0')}.json`;
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }
    
      // === ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ===
  const btnExport = (window.__WBP_GET_EXPORT_BUTTON__?.() || document.getElementById('btnExportAll'));
  function handleExportClick(e){
    e.preventDefault();
    e.stopImmediatePropagation();  // í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” ë‹¤ë¥¸ ë¦¬ìŠ¤ë„ˆê°€ ë˜ ë°›ì§€ ëª»í•˜ê²Œ
    const payload = {
      __type: 'WBP_EXPORT',
      __version: '3.5',
      __createdAt: new Date().toISOString(),
      data: collectAll()
    };
    downloadJSON(payload);
  }
  // ì¤‘ë³µ ë°©ì§€: data-boundExport ì²´í¬
  if (btnExport && btnExport.dataset.boundExport !== '2') {
    btnExport.addEventListener('click', handleExportClick, {capture:true});
    btnExport.dataset.boundExport = '2';
  }

  // === ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼/íŒŒì¼ ===
  const btnImport = document.getElementById('btnImportAll');
  const fileInp   = document.getElementById('importFile');
  btnImport?.addEventListener('click', ()=> fileInp?.click());
  fileInp?.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () =>{
      try{
        const json = JSON.parse(String(reader.result||'{}'));
        const bag = json.data || json;
        let count = 0;
        for(const [k,v] of Object.entries(bag)){
          if(!k) continue;
          if (typeof saveState === 'function') {
            saveState(k, v);
          } else {
            localStorage.setItem(k, typeof v==='string' ? v : JSON.stringify(v));
          }
          count++;
        }
        alert(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ${count}ê°œ í•­ëª©ì„ ë³µì›í–ˆìŠµë‹ˆë‹¤.`);
        document.dispatchEvent(new CustomEvent('wbp:importApplied'));
        document.dispatchEvent(new CustomEvent('wbp:treeBuilt'));
      }catch(err){
        console.error(err);
        alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON íŒŒì‹± ì˜¤ë¥˜');
      }finally{
        e.target.value = '';
      }
    };
    reader.readAsText(f, 'utf-8');
  });
});
</script>


</body>
</html>